{% extends "layout.html" %}

{% block content %}
<div class="row gx-4 gy-4">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Analyze text</h5>
        <form method="post" action="{{ url_for('analyze') }}">
          <div class="mb-3">
            <textarea name="text" class="form-control form-control-lg" rows="4" placeholder="Type or paste text here... (Ctrl+Enter to submit)"></textarea>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">Analyze</button>
            <form method="post" action="{{ url_for('clear') }}" style="display:inline;">
              <button class="btn btn-outline-danger" type="submit">Clear all</button>
            </form>
          </div>
        </form>
      </div>
    </div>

    <div class="mt-3">
      <div class="row g-3">
        <div class="col-sm-4">
          <div class="card border-success h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-success">Positive</h6>
              <ul class="list-unstyled small" id="positive-list">
                {% for e in store.positive %}
                  <li class="mb-2"><strong>{{ e.score }}</strong> — {{ e.text|e }}</li>
                {% else %}
                  <li class="text-muted small">No items</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>

        <div class="col-sm-4">
          <div class="card border-secondary h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-secondary">Neutral</h6>
              <ul class="list-unstyled small" id="neutral-list">
                {% for e in store.neutral %}
                  <li class="mb-2"><strong>{{ e.score }}</strong> — {{ e.text|e }}</li>
                {% else %}
                  <li class="text-muted small">No items</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>

        <div class="col-sm-4">
          <div class="card border-danger h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-danger">Negative</h6>
              <ul class="list-unstyled small" id="negative-list">
                {% for e in store.negative %}
                  <li class="mb-2"><strong>{{ e.score }}</strong> — {{ e.text|e }}</li>
                {% else %}
                  <li class="text-muted small">No items</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm chart-card">
      <div class="card-body">
        <h5 class="card-title">Sentiment distribution</h5>

        <!-- fixed-height wrapper keeps the chart from pushing layout -->
        <div class="chart-wrapper">
          <canvas id="sentimentChart"></canvas>
        </div>

        <div class="mt-3 d-flex justify-content-between">
          <div class="small text-success">Positive</div>
          <div class="small text-secondary">Neutral</div>
          <div class="small text-danger">Negative</div>
        </div>
      </div>
    </div>

    <div class="mt-3 text-muted small">
      Scores are computed with VADER and a small local preprocessor. Add texts to see the chart update.
    </div>
  </div>
</div>

<script>
(async function initChart(){
  const ctx = document.getElementById('sentimentChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Positive','Neutral','Negative'],
      datasets: [{
        data: [0.0, 0.0, 0.0],
        backgroundColor: ['#2ecc71','#95a5a6','#e74c3c'],
        hoverOffset: 8,
        borderWidth: 0
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      maintainAspectRatio: false
    }
  });

  function buildDataset(json){
    const raw = [
      { key:'positive', label:'Positive', value: json.pos || 0, color:'#2ecc71', count: json.counts?.positive || 0 },
      { key:'neutral',  label:'Neutral',  value: json.neu || 0, color:'#95a5a6', count: json.counts?.neutral || 0 },
      { key:'negative', label:'Negative', value: json.neg || 0, color:'#e74c3c', count: json.counts?.negative || 0 }
    ];

    // Keep only categories with at least one stored item (count > 0).
    // This ensures empty categories (like neutral with no entries) are not shown.
    let filtered = raw.filter(r => r.count > 0);

    // If there are stored items but some have zero computed proportion due to rounding,
    // include them (so counts drive visibility).
    if(filtered.length === 0){
      // No stored items at all -> show a single neutral "No data" slice (visually empty)
      return { labels: ['No data'], data: [1], colors: ['#95a5a6'] };
    }

    // Build final arrays using the filtered set. Use the computed value for sizing.
    const labels = filtered.map(r => r.label);
    const data = filtered.map(r => r.value);
    const colors = filtered.map(r => r.color);

    // If all values are zero (shouldn't happen with counts>0, but guard anyway),
    // fallback to equal slices so chart still renders reasonably.
    if(data.every(v => v === 0)){
      return { labels, data: labels.map(() => 1), colors };
    }

    return { labels, data, colors };
  }

  async function refresh(){
    const res = await fetch('{{ url_for("data") }}');
    const json = await res.json();
    const ds = buildDataset(json);

    chart.data.labels = ds.labels;
    chart.data.datasets[0].data = ds.data;
    chart.data.datasets[0].backgroundColor = ds.colors;
    chart.update();
  }

  await refresh();
  setInterval(refresh, 3000);
})();
</script>
{% endblock %}